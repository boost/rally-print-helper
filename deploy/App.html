<!DOCTYPE html>
<html>
<head>
    <title>boost-rallyprinter</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Boost.rally.PrintGrid",{extend:"Ext.grid.Panel",alias:"widget.printgrid",title:"Print Grid",columnLines:!0,border:!1,emptyText:"No records found",hideIteration:!1,styleSheetPath:"print.css",remote:!1,initComponent:function(){var self=this,config={};self._setRemote(),self._buildColumns(config),self._buildSelectionModel(config),self._buildTbar(config),Ext.apply(this,config),this.callParent(arguments)},_setRemote:function(){var self=this,url=window.location.origin,expression=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi,regex=RegExp(expression);url.match(regex)&&(self.remote=!0)},_buildColumns:function(config){config.columns=[{xtype:"rownumberer"},{text:"ID",dataIndex:"FormattedID",flex:1,sortable:!1},{text:"Story Name",dataIndex:"Name",flex:3,sortable:!1}]},_buildSelectionModel:function(config){var self=this;config.selModel=Ext.create("Ext.selection.CheckboxModel",{mode:"MULTI",allowDeselect:!0,listeners:{scope:self,selectionchange:self._selectRecord}})},_buildTbar:function(config){var self=this,items=[],printBtn=Ext.create("Ext.button.Button",{text:"Print",handler:self._printIteration,scope:self,disabled:!0});if(self.printBtn=printBtn,self.hideIteration)items=["->",printBtn];else{var store=Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",fetch:!0,sorters:[{property:"EndDate",direction:"DESC"}]}),iterationBox=Ext.create("Ext.form.field.ComboBox",{store:store,displayField:"Name",valueField:"ObjectID",triggerAction:"all",listeners:{scope:self,change:self._iterationCallback}});store.on("load",function(st){iterationBox.setValue(st.getAt(0).get("ObjectID"))}),store.load(),items=[iterationBox,"->",printBtn]}config.tbar=items},_printIteration:function(cb){var self=this,selections=self.getSelectionModel().getSelection();selections.length>0&&self._buildTemplate(selections)},_buildTemplate:function(selections){var self=this,data=self._sanitizeData(selections),tpl=new Ext.XTemplate(['<tpl for="artifacts">','<div class="artifact">','<div class="ratio-control">','<div class="card-frame">','<div class="header">','<span class="storyID">{id}</span>','<span class="ownerText">{owner}</span>',"</div>",'<div class="content">','<span class="card-title">{name}</span>','<span class="description">{description}</span>',"</div>",'<span class="estimate">Size: {estimate}</span>','<span class="rank">Rank: {#}</span>',"</div>","</div>","</div>",'<div class="{defineBreak}"></div>',"</tpl>"]),markup=tpl.apply(data);self._printCards(markup)},_selectRecord:function(selModel){var self=this;selModel.hasSelection()?self.printBtn.enable():self.printBtn.disable()},_sanitizeData:function(selections){var data={artifacts:[]};return Ext.Array.each(selections,function(selection){var obj={name:selection.get("Name"),description:selection.get("Description"),id:selection.get("FormattedID"),estimate:selection.get("PlanEstimate")};selection.get("Owner")&&(obj.owner=selection.get("Owner")._refObjectName),data.artifacts.push(obj)}),data},_iterationCallback:function(cmb,recordId,oldVal,opts){var self=this,store=self.getStore(),filters=[{property:"Iteration",operator:"=",value:"/iteration/"+recordId}];store.reload({filters:filters}),store.filter(filters)},_printCards:function(markup){var self=this,options="toolbar=1,menubar=1,scrollbars=yes,scrolling=yes,resizable=yes,width=1000,height=500",win=window.open("",self.printTitle,options),doc=win.document;return doc.write("<html><head><title>"+self.printTitle+"</title>"),self.remote?doc.write('<link href=https://raw.github.com/boost/rally-print-helper/master/print.css rel="stylesheet" type="text/css" media="screen,print" />'):doc.write('<link href="'+self.styleSheetPath+'" rel="stylesheet" type="text/css" media="screen,print" />'),doc.write('</head><body class="landscape">'),doc.write(markup),doc.write("</body></html>"),doc.close(),win.focus(),win.print(),!1}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",printTitle:"Boost Print Helper",launch:function(){var self=this;self._buildTabs()},_buildTabs:function(){var self=this,userStoriesGrid=Ext.create("Boost.rally.PrintGrid",{store:Ext.create("Rally.data.WsapiDataStore",{model:"User Story",autoLoad:!1,sorters:[{property:"Rank",direction:"ASC"}]}),title:"User Stories"}),backlogStore=Ext.create("Rally.data.WsapiDataStore",{model:"User Story",autoLoad:!1,sorters:[{property:"Rank",direction:"ASC"}]}),filters=[{property:"Release",operator:"=",value:"null"},{property:"Iteration",operator:"=",value:"null"},{property:"DirectChildrenCount",operator:"=",value:"0"}];backlogStore.filter(filters);var backlogGrid=Ext.create("Boost.rally.PrintGrid",{store:backlogStore,hideIteration:!0,title:"Backlog"}),tab=Ext.create("Ext.tab.Panel",{activeTab:0,border:!1,items:[userStoriesGrid,backlogGrid]});self.add(tab)}});

            Rally.launchApp('CustomApp', {
                name:"boost-rallyprinter",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body></body>
</html>
